id: spip_enews_articles_auto_paginate
label: '[SPIP] eNews Articles Import with Auto-Pagination'
migration_group: spip_import
source:
  plugin: spip_xml_file
  url: 'https://uic.org/com/?page=enews_export'
  item_selector: '//rubrique'
  auto_paginate: true
  per_page: 20

process:
  # Node type
  type:
    plugin: default_value
    default_value: article
  
  # Language
  langcode:
    plugin: default_value
    default_value: en
  
  # Title (required field)
  title: titre
  
  # Body field with format
  body/value:
    - plugin: spip_raccourcis_to_html
      source: texte
      base_url: 'https://uic.org/com/'
    - plugin: spip_doc_to_embed
      base_url: 'https://uic.org/com/'
      doc_path_pattern: 'IMG'
    - plugin: spip_html_transform
    - plugin: spip_html_media_embed
      base_url: 'https://uic.org/com/'
  body/format:
    plugin: default_value
    default_value: full_html
    
  # SPIP URL field
  field_spip_url: formerurl
  
  # Subtitle field
  field_subtitle: soustitre

  # Header (chapo) in SPIP syntax
  field_header/value:
    - plugin: spip_raccourcis_to_html
      source: chapo
      base_url: 'https://uic.org/com/'
    - plugin: spip_doc_to_embed
      base_url: 'https://uic.org/com/'
      doc_path_pattern: 'IMG'
    - plugin: spip_html_transform
    - plugin: spip_html_media_embed
      base_url: 'https://uic.org/com/'
      reuse_existing: true
      use_media: true
  field_header/format:
    plugin: default_value
    default_value: full_html

  # Footer (ps) in SPIP syntax
  field_footer/value:
    - plugin: spip_raccourcis_to_html
      source: ps
      base_url: 'https://uic.org/com/'
    - plugin: spip_doc_to_embed
      base_url: 'https://uic.org/com/'
      doc_path_pattern: 'IMG'
    - plugin: spip_html_transform
    - plugin: spip_html_media_embed
      base_url: 'https://uic.org/com/'
      reuse_existing: true
      use_media: true
  field_footer/format:
    plugin: default_value
    default_value: full_html
  
  # SPIP ID (unique identifier)
  field_spip_id: id
    
  # Image principale depuis logourl (si présent)
  # - Référence un fichier déjà présent dans public://images/spip via son filename
  # - Nécessite que les fichiers soient indexés dans file_managed (voir script index_spip_images.sh)
  field_image/target_id:
    - plugin: skip_on_empty
      source: logourl
      method: process
    - plugin: log_value
      message: 'Image pipeline: logourl basename before lookup @value'
    - plugin: callback
      callable: basename
    - plugin: log_value
      message: 'Image pipeline: basename computed @value'
    - plugin: entity_lookup
      entity_type: file
      value_key: filename
      access_check: false
    - plugin: log_value
      message: 'Image pipeline: file entity_lookup result fid @value'
  field_image/alt:
    - plugin: skip_on_empty
      source: logourl
      method: process
    - plugin: log_value
      message: 'Image pipeline: logourl present, setting ALT from titre'
    - plugin: get
      source: titre

  # Tags - split by semicolon and create/reference taxonomy terms
  field_tags:
    - plugin: skip_on_empty
      source: tags1
      method: process
    - plugin: explode
      delimiter: ';'
    - plugin: callback
      callable: trim
    - plugin: entity_generate
      entity_type: taxonomy_term
      bundle: tags
      value_key: name
      bundle_key: vid

destination:
  plugin: 'entity:node'
  default_bundle: article

migration_dependencies:
  required: []
  optional: []
