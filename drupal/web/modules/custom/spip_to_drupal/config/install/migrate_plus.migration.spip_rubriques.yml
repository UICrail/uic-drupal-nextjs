id: spip_rubriques
label: '[SPIP] Rubriques Import - Auto-Pagination'
migration_group: spip_import
source:
  plugin: spip_xml_file
  url: 'https://uic.org/?page=rubriques_export'
  item_selector: '//*[local-name()="rubrique"]'
  # Enable auto-pagination; no hard cap (fetch until no more items)
  auto_paginate: true

process:
  # Node type
  type:
    plugin: default_value
    default_value: activity_page

  # Language
  langcode:
    plugin: default_value
    default_value: en

  # Title (required field)
  title: titre

  # SPIP ID (unique identifier)
  field_spip_id: id

  # Subtitle field
  field_subtitle: soustitre

  # Header/Description field (SPIP 'desc')
  field_header/value:
    - plugin: spip_raccourcis_to_html
      source: desc
      base_url: 'https://uic.org/'
    - plugin: spip_auto_link
      base_url: 'https://uic.org/'
    - plugin: spip_doc_to_embed
      base_url: 'https://uic.org/'
      doc_path_pattern: 'IMG'
      documents_index_url: 'https://uic.org/?page=documents_exportxml'
      documents_index_urls:
        - 'https://uic.org/?page=documents_exportxml'
        - 'https://uic.org/com/?page=documents_exportxml'
      documents_id_param: 'id_document'
    - plugin: spip_html_transform
    - plugin: spip_html_media_embed
      base_url: 'https://uic.org/'
      destination_scheme: 'public://'
      destination_subdir: 'activity/images'
      reuse_existing: true
      use_media: true
  field_header/format:
    plugin: default_value
    default_value: full_html

  # Body field with format (SPIP 'texte')
  body/value:
    - plugin: spip_raccourcis_to_html
      source: texte
      base_url: 'https://uic.org/'
    - plugin: spip_auto_link
      base_url: 'https://uic.org/'
    - plugin: spip_doc_to_embed
      base_url: 'https://uic.org/'
      doc_path_pattern: 'IMG'
      documents_index_url: 'https://uic.org/?page=documents_exportxml'
      documents_index_urls:
        - 'https://uic.org/?page=documents_exportxml'
        - 'https://uic.org/com/?page=documents_exportxml'
      documents_id_param: 'id_document'
    - plugin: spip_html_transform
    - plugin: spip_html_media_embed
      base_url: 'https://uic.org/'
      destination_scheme: 'public://'
      destination_subdir: 'spip/images'
      reuse_existing: true
      use_media: true
      media_bundle: 'image'
      media_image_field: 'field_media_image'
      strip_width_height: true
  body/format:
    plugin: default_value
    default_value: full_html

  # Image principale depuis logourl -> Media entity dans field_featured_image
  field_featured_image:
    - plugin: skip_on_empty
      source: logourl
      method: process
    - plugin: spip_logourl_to_media_id
      base_url: 'https://uic.org/'
      destination_scheme: 'public://'
      destination_subdir: 'spip/images'
      media_bundle: 'image'
      media_file_field: 'field_media_image'
      reuse_existing: true
      allowed_extensions: ['jpg','jpeg','png','gif','webp']

  # Tags - split by semicolon and create/reference taxonomy terms
  field_tags:
    - plugin: skip_on_empty
      source: group1
      method: process
    - plugin: explode
      delimiter: ';'
    - plugin: callback
      callable: trim
    - plugin: skip_on_empty
      method: process
    - plugin: entity_generate
      entity_type: taxonomy_term
      bundle: tags
      value_key: name
      bundle_key: vid

  # Gallery images -> Media references (multi-value) from <images>
  field_gallery:
    - plugin: spip_portfolio_to_media
      source: images
      base_url: 'https://uic.org/'
      documents_index_url: 'https://uic.org/?page=documents_exportxml'
      documents_index_urls:
        - 'https://uic.org/?page=documents_exportxml'
        - 'https://uic.org/com/?page=documents_exportxml'
      id_prefixes: 'doc,comdoc'
      documents_id_param: 'id_document'
      destination_scheme: 'public://'
      destination_subdir: 'spip/documents'
      media_bundle: 'image'
      media_file_field: 'field_media_image'
      reuse_existing: true
      allowed_extensions: ['jpg','jpeg','png','gif','webp']

  # Attachments from <portfolio> -> Media Document references
  field_attachments:
    - plugin: spip_portfolio_to_media
      source: portfolio
      base_url: 'https://uic.org/'
      documents_index_url: 'https://uic.org/?page=documents_exportxml'
      documents_index_urls:
        - 'https://uic.org/?page=documents_exportxml'
        - 'https://uic.org/com/?page=documents_exportxml'
      id_prefixes: 'doc,comdoc'
      documents_id_param: 'id_document'
      destination_scheme: 'public://'
      destination_subdir: 'spip/documents'
      media_bundle: 'document'
      media_file_field: 'field_media_document'
      reuse_existing: true
      allowed_extensions: ['pdf','doc','docx','xls','xlsx','ppt','pptx','zip','rtf','txt']

destination:
  plugin: 'entity:node'
  default_bundle: activity_page

migration_dependencies:
  required: []
  optional: []


